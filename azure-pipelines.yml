variables:
  npm_config_cache: $(Pipeline.Workspace)/.npm

trigger:
  - main

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Pre
    jobs:
      - job: PreTest
        steps:
          - script: echo "Pre test script"
      - job: Pre_Test_2
        steps:
          - script: echo "Another job run"    

  - stage: Test
    jobs:
      - job: TestWork
        strategy:
          matrix:
            demo:
              shard: '1/3'
            example1:
              shard: '2/3'
            example2:
              shard: '3/3'

        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'
          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                   npm | "$(Agent.OS)"
              path: $(npm_config_cache)
            displayName: Cache npm  
            
          - script: |
              npm install
              npx playwright install --with-deps
            displayName:  'Install npm deps'
          - script: npm test --shard=$(shard)
          - script: ls
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'results.xml'
              mergeTestResults: true
              failTaskOnFailedTests: true
              testRunTitle: 'My End-To-End Tests'
            condition: succeededOrFailed()
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: playwright-report
              artifact: playwright-report-$(shard)
              publishLocation: 'pipeline'
            condition: succeededOrFailed()


  - stage: Post
    jobs:
      - job: PostTest
        steps:
          - script: echo "Post test script"
